{% extends "base.html" %}

{% block title %}Aruuz Nigar: a Urdu Scansion Tool{% endblock %}

{% block content %}
<div class="container my-5">

    <h1 class="text-center mb-4">Aruuz Nigar: a Urdu Scansion Tool</h1>

    <!-- Input Card -->
    <div class="card mb-3">
        <div class="card-body py-3">
            <form method="POST" action="/islah" class="needs-validation" novalidate>
                <label for="text" class="form-label">Enter Urdu Poetry Lines (one per line)</label>

                <textarea
                    class="form-control form-control-lg urdu-input mb-3"
                    id="text"
                    name="text"
                    dir="rtl"
                    lang="ur"
                    placeholder="نقش فریادی ہے کس کی شوخیِ تحریر کا&#10;کاغذی پیرہن میں ہے بند صدف کی طرح"
                    required
                    autofocus
                    rows="5"
                >{% if text_input %}{{ text_input }}{% endif %}</textarea>

                <div class="invalid-feedback">
                    Please enter Urdu poetry lines.
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100 py-2">
                    Scan Lines
                </button>
            </form>
        </div>
    </div>

    <!-- Error -->
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show">
        <strong>Error</strong> {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Legend -->
    {% if line_results %}
    <div class="alert alert-light border mb-2 py-1" role="alert">
        <small class="text-muted">
            <strong>Legend:</strong>
            <span class="ms-2"><code class="text-dark">–</code> short syllable</span>
            <span class="ms-3"><code class="text-dark">=</code> long syllable</span>
            <span class="ms-3"><code class="text-dark">X</code> flexible (short or long)</span>
        </small>
    </div>

    {% for line_data in line_results %}
    <div class="card mb-3">
        <div class="card-header bg-primary bg-opacity-10">
            <strong class="urdu-text">Line {{ line_data.line_index + 1 }}</strong>
            <span class="urdu-text word-value ms-2" dir="rtl" lang="ur">{{ line_data.original_line }}</span>
        </div>

        <div class="card-body py-2">

            {% if line_data.results %}

                {% set dominant_result = line_data.results
                    |selectattr("is_dominant", "equalto", true)
                    |first %}
                {% if not dominant_result %}
                    {% set dominant_result = line_data.results[0] %}
                {% endif %}

                {% for result in line_data.results %}
                <div class="mb-2
                    {% if result.is_dominant %}
                        border border-success border-3 rounded p-2 bg-success bg-opacity-10
                    {% else %}
                        border rounded p-2
                    {% endif %}
                ">

                    <!-- Meter -->
                    <div class="mb-2">
                        <strong>Meter (Bahr)</strong>
                        <span class="{% if result.is_dominant %}fw-bold text-success{% endif %} urdu-text" dir="rtl" lang="ur">
                            {{ result.meter_name }}
                        </span>

                        {% if result.is_dominant %}
                        <span class="badge bg-success ms-2">Dominant</span>
                        {% endif %}
                    </div>

                    <!-- Full Code -->
                    <div class="mb-2">
                        <span class="badge bg-primary me-2 small">Full Code</span>
                        <span class="code-value" dir="rtl">{{ result.full_code }}</span>
                    </div>

                    <!-- Word-by-Word -->
                    <div class="border-top pt-2">
                        <div class="badge bg-info mb-1 small">Word-by-Word Codes</div>

                        <div class="table-responsive mb-2">
                            <table class="table table-bordered table-sm mb-0 text-center align-middle" dir="rtl">
                                <tr>
                                    {% for wc in result.word_codes %}
                                    <td class="bg-light">
                                        <span class="urdu-text" style="font-size:1.1rem;" dir="rtl" lang="ur">
                                            {{ wc.word }}
                                        </span>
                                    </td>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    {% for wc in result.word_codes %}
                                    <td>
                                        <span dir="rtl">{{ wc.code }}</span>
                                    </td>
                                    {% endfor %}
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Feet -->
                    {% if result.feet_list and result.feet_list|length > 0 %}
                    <div class="border-top pt-2">
                        <div class="badge bg-info mb-1 small">Feet (Arkaan)</div>

                        <div class="table-responsive mb-2">
                            <table class="table table-bordered table-sm mb-0 text-center align-middle" dir="rtl">
                                <tr>
                                    {% for foot in result.feet_list %}
                                    <td class="bg-light">
                                        <span class="urdu-text" style="font-size:1.1rem;" dir="rtl" lang="ur">
                                            {{ foot.foot }}
                                        </span>
                                    </td>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    {% for foot in result.feet_list %}
                                    <td>
                                        <span dir="rtl">{{ foot.code }}</span>
                                    </td>
                                    {% endfor %}
                                </tr>
                            </table>
                        </div>
                    </div>

                    {% elif result.feet %}
                    <div class="border-top pt-2">
                        <span class="badge bg-info me-2 small">Feet</span>
                        <span class="code-value" dir="rtl">{{ result.feet }}</span>
                    </div>
                    {% endif %}

                </div>
                {% endfor %}

            {% else %}
            <div class="alert alert-warning">
                No meter matches found for this line.
            </div>
            {% endif %}

        </div>
    </div>
    {% endfor %}
    {% endif %}

    <footer class="text-center mt-4 text-muted small">
        <p>Aruuz Nigar: a Urdu Scansion Tool – Phase 1</p>
    </footer>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
    'use strict';
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
})();
</script>
{% endblock %}
