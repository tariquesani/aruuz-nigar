{% extends "base.html" %}

{% block title %}Aruuz Nigar: a Urdu Scansion Tool{% endblock %}

{% block content %}
<div class="container my-5">

    <h1 class="text-center mb-4">Aruuz Nigar: a Urdu Scansion Tool</h1>

    <!-- Error -->
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show">
        <strong>Error</strong> {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Results Section (if available) -->
    {% if line_results %}
    <!-- Legend -->
    <div class="alert alert-light border mb-2 py-1" role="alert">
        <small class="text-muted">
            <strong>Legend:</strong>
            <span class="ms-2"><code class="text-dark">–</code> short syllable</span>
            <span class="ms-3"><code class="text-dark">=</code> long syllable</span>
            <span class="ms-3"><code class="text-dark">X</code> flexible (short or long)</span>
        </small>
    </div>

    {% for line_data in line_results %}
    <div class="card mb-5">
        <div class="card-body py-3">
            <!-- Centered line text -->
            <h5 class="text-center urdu-text mb-4" dir="rtl" lang="ur">{{ line_data.original_line }}</h5>
            
            {% if line_data.results %}
                {% set dominant_result = line_data.results
                    |selectattr("is_dominant", "equalto", true)
                    |first %}
                {% if not dominant_result %}
                    {% set dominant_result = line_data.results[0] %}
                {% endif %}
                
                {% if dominant_result.syllables and dominant_result.full_code %}
                    {% set has_match = dominant_result.meter_name != 'No meter match found' %}
                    {% if has_match and dominant_result.meter_pattern %}
                        {# When there's a match, use the meter pattern (resolved, no x) #}
                        {% set notation_code = dominant_result.meter_pattern %}
                    {% elif has_match and dominant_result.feet_list %}
                        {# Fallback: reconstruct from feet codes #}
                        {% set notation_code = "" %}
                        {% for foot in dominant_result.feet_list %}
                            {% set notation_code = notation_code + foot.code %}
                        {% endfor %}
                        {# If still doesn't match length, use full_code #}
                        {% if notation_code | length != dominant_result.full_code | length %}
                            {% set notation_code = dominant_result.full_code %}
                        {% endif %}
                    {% else %}
                        {# No match: use full_code which may contain x #}
                        {% set notation_code = dominant_result.full_code %}
                    {% endif %}
                    
                    <!-- Table with syllables, notation, and feet -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center align-middle mb-0">
                            <!-- Syllable row -->
                            <tr>
                                {% for syllable in dominant_result.syllables %}
                                <td class="urdu-text" dir="rtl" lang="ur" style="font-size:1.1rem;">{{ syllable }}</td>
                                {% endfor %}
                            </tr>
                            <!-- Notation row: show derived code (with x) if no match, or dominant bahr notation (only - and =) if match -->
                            <tr>
                                {% for char in notation_code %}
                                <td><code class="text-dark" style="font-size: 1.5rem; font-weight: bold;">{{ char }}</code></td>
                                {% endfor %}
                            </tr>
                            <!-- Feet row with merged cells (only show if there's a match) -->
                            {% if has_match and dominant_result.feet_list %}
                            <tr>
                                {% for foot in dominant_result.feet_list %}
                                    {% set foot_length = foot.code | length %}
                                    {% if loop.index0 % 2 == 0 %}
                                    <td colspan="{{ foot_length }}" class="urdu-text" dir="rtl" lang="ur" style="font-size:1.1rem; background-color: #e9ecef;">{{ foot.foot }}</td>
                                    {% else %}
                                    <td colspan="{{ foot_length }}" class="urdu-text" dir="rtl" lang="ur" style="font-size:1.1rem; background-color: white;">{{ foot.foot }}</td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                    
                    <!-- Centered bahr name for this line -->
                    {% if has_match %}
                    <h6 class="text-center mt-3 urdu-text" dir="rtl" lang="ur">{{ dominant_result.meter_name }}</h6>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning">
                        No scansion data available for this line.
                    </div>
                {% endif %}
            {% else %}
                <div class="alert alert-warning">
                    No meter matches found for this line.
                </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    
    <!-- Show dominant bahr for all lines -->
    {% if dominant_bahrs and dominant_bahrs|length > 0 %}
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="text-center urdu-text mb-0" dir="rtl" lang="ur">
                {% for bahr in dominant_bahrs %}
                    {{ bahr }}{% if not loop.last %}, {% endif %}
                {% endfor %}
                <strong>Bahr </strong> 
            </h5>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Input Card -->
    <div class="card mb-3">
        <div class="card-body py-3">
            <form method="POST" action="/" class="needs-validation" novalidate>
                <label for="text" class="form-label">Enter Urdu Poetry Lines (one per line)</label>

                <textarea
                    class="form-control form-control-lg urdu-input mb-3"
                    id="text"
                    name="text"
                    dir="rtl"
                    lang="ur"
                    placeholder="نقش فریادی ہے کس کی شوخیِ تحریر کا&#10;کاغذی پیرہن میں ہے بند صدف کی طرح"
                    required
                    autofocus
                    rows="5"
                >{% if text_input %}{{ text_input }}{% endif %}</textarea>

                <div class="invalid-feedback">
                    Please enter Urdu poetry lines.
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100 py-2">
                    Scan Lines
                </button>
            </form>
        </div>
    </div>

    <footer class="text-center mt-4 text-muted small">
        <p>Aruuz Nigar: a Urdu Scansion Tool – Phase 1</p>
    </footer>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
    'use strict';
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
})();
</script>
{% endblock %}
