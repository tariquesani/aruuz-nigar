{% extends "base.html" %}

{% block title %}Aruuz Nigar: a Urdu Scansion Tool{% endblock %}

{% block content %}
<div class="container my-5">

    <h1 class="text-center mb-4">Aruuz Nigar: a Urdu Scansion Tool</h1>

    <!-- Error -->
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show">
        <strong>Error</strong> {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Results Section (if available) -->
    {% if line_results %}
    <!-- Legend -->
    <div class="alert alert-light border mb-2 py-1" role="alert">
        <small class="text-muted">
            <strong>Legend:</strong>
            <span class="ms-2"><code class="text-dark">–</code> short syllable</span>
            <span class="ms-3"><code class="text-dark">=</code> long syllable</span>
            <span class="ms-3"><code class="text-dark">X</code> flexible (short or long)</span>
        </small>
    </div>

    {% for line_data in line_results %}
    <div class="card mb-5">
        <div class="card-body py-3">
            <!-- Centered line text -->
            <h5 class="text-center urdu-text mb-4" dir="rtl" lang="ur">{{ line_data.original_line }}</h5>
            
            {% if line_data.results %}
                {% set dominant_result = (line_data.results | selectattr("is_dominant", "equalto", true) | first) or line_data.results[0] %}
                
                {% if dominant_result.word_codes and dominant_result.full_code %}
                    {% set has_match = dominant_result.meter_name != 'No meter match found' %}
                    {% if has_match and dominant_result.meter_pattern %}
                        {% set notation_code = dominant_result.meter_pattern %}
                    {% elif has_match and dominant_result.feet_list %}
                        {% set notation_code = (dominant_result.feet_list | map(attribute="code") | join("")) %}
                        {% if notation_code | length != dominant_result.full_code | length %}
                            {% set notation_code = dominant_result.full_code %}
                        {% endif %}
                    {% else %}
                        {% set notation_code = dominant_result.full_code %}
                    {% endif %}
                    
                    <!-- Table with words, notation, and feet -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center align-middle mb-0" dir="rtl">
                            <!-- Word row (skip standalone و when it has empty notation) -->
                            <tr>
                                {% for word_data in dominant_result.word_codes %}
                                    {% if not (word_data.word == "و" and not word_data.code) %}
                                        <td colspan="{{ word_data.code | length }}" class="urdu-text" dir="rtl" lang="ur" style="font-size:1.1rem;">{{ word_data.word }}</td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                            <!-- Notation row: show derived code (with x) if no match, or dominant bahr notation (only - and =) if match -->
                            <tr>
                                {% for char in notation_code %}
                                <td><code class="text-dark" style="font-size: 1.5rem; font-weight: bold;">{{ char }}</code></td>
                                {% endfor %}
                            </tr>
                            <!-- Feet row with merged cells (only show if there's a match) -->
                            {% if has_match and dominant_result.feet_list %}
                            {% set total_bahr_length = notation_code | length %}
                            {% set has_plus = '+' in notation_code %}
                            <tr>
                                {% for foot in dominant_result.feet_list %}
                                    {% set foot_length = foot.code | length %}
                                    {# Increase second foot colspan by 1 if + is present in meter pattern #}
                                    {% if has_plus and loop.index0 == 1 %}
                                        {% set foot_length = foot_length + 1 %}
                                    {% endif %}
                                    {% set foot_percentage = (foot_length / total_bahr_length * 100) | round(2) %}
                                    {% set bg_color = "#e9ecef" if loop.index0 % 2 == 0 else "white" %}
                                    <td colspan="{{ foot_length }}" class="urdu-text" dir="rtl" lang="ur" style="font-size:1.1rem; background-color: {{ bg_color }}; width: {{ foot_percentage }}%;">{{ foot.foot }}</td>
                                {% endfor %}
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                    
                    <!-- Check if any و was dropped due to ataf processing -->
                    {% set waw_dropped = dominant_result.word_codes | selectattr("word", "equalto", "و") | rejectattr("code") | list | length > 0 %}
                    
                    
                    <!-- Centered bahr name for this line (per-line dominant) -->
                    {% if has_match %}
                    <div class="text-center mt-3">
                        <h6>
                            <!-- Message for dropped و -->
                            {% if waw_dropped %}
                                    A  'و'  has been dropped by ataf processing.
                            {% endif %}
                            Bahr: <span dir="rtl" lang="ur" class="urdu-text">{{ dominant_result.meter_name }}</span>
                        </h6>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning">
                        No scansion data available for this line.
                    </div>
                {% endif %}
            {% else %}
                <div class="alert alert-warning">
                    No meter matches found for this line.
                </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    
    <!-- Show overall dominant bahr for the entire poem -->
    {% if poem_dominant_bahrs %}
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="text-center urdu-text mb-0" >
                Poem Bahr: <span dir="rtl" lang="ur">{{ poem_dominant_bahrs | join(", ") }}</span>
            </h5>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Input Card -->
    <div class="card mb-3">
        <div class="card-body py-3">
            <form method="POST" action="/" class="needs-validation" novalidate>
                <label for="text" class="form-label">Enter Urdu Poetry Lines (one per line)</label>

                <textarea
                    class="form-control form-control-lg urdu-input mb-3"
                    id="text"
                    name="text"
                    dir="rtl"
                    lang="ur"
                    placeholder="نقش فریادی ہے کس کی شوخیِ تحریر کا&#10;کاغذی پیرہن میں ہے بند صدف کی طرح"
                    required
                    autofocus
                    rows="5"
                >{{ text_input or "" }}</textarea>

                <div class="invalid-feedback">
                    Please enter Urdu poetry lines.
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100 py-2">
                    Scan Lines
                </button>
            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
    'use strict';
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
})();
</script>
{% endblock %}
