{% extends "base.html" %}

{% block title %}Aruuz Nigar: Urdu Poetry Scansion Tool{% endblock %}

{% block content %}
<div class="container my-5">

    <h1 class="text-center mb-4">Aruuz Nigar: Urdu Poetry Scansion Tool</h1>

    <!-- Error -->
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show">
        <strong>Error</strong> {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Results Section (if available) -->
    {% if line_results %}
    <!-- Legend -->
    <div class="alert alert-light border mb-2 py-1" role="alert">
        <small class="text-muted">
            <strong>Legend:</strong>
            <span class="ms-2"><code class="text-dark">–</code> short syllable</span>
            <span class="ms-3"><code class="text-dark">=</code> long syllable</span>
            <span class="ms-3"><code class="text-dark">X</code> flexible (short or long)</span>
        </small>
    </div>

    {% for line_data in line_results %}
    <div class="card mb-5">
        <div class="card-body py-3">
            <!-- Centered line text -->
            <h5 class="text-center urdu-text mb-4" dir="rtl" lang="ur">{{ line_data.original_line }}</h5>
            
            {% if line_data.results %}
                {% set multi = (line_data.results | length >= 2) %}
                {% for result in line_data.results %}
                    {% set has_match = (result.meter_name != 'No meter match found') %}
                    {% if has_match and result.meter_pattern %}
                        {% set notation_code = result.meter_pattern %}
                    {% elif has_match and result.feet_list %}
                        {% set notation_code = (result.feet_list | map(attribute="code") | join("")) %}
                        {% if notation_code | length != result.full_code | length %}
                            {% set notation_code = result.full_code %}
                        {% endif %}
                    {% else %}
                        {% set notation_code = result.full_code %}
                    {% endif %}
                    {% set waw_dropped = (result.word_codes | selectattr("word", "equalto", "و") | rejectattr("code") | list | length > 0) %}
                    <div class="scansion-table-wrapper {{ 'd-none' if (multi and not result.is_default) else '' }}" data-line-index="{{ line_data.line_index }}" data-bahr-index="{{ loop.index0 }}" data-meter-name="{{ result.meter_name }}">
                        {% if result.word_codes and result.full_code %}
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm text-center align-middle mb-0" dir="rtl">
                                    <tr>
                                        {% for word_data in result.word_codes %}
                                            {% if not (word_data.word == "و" and not word_data.code) %}
                                                <td colspan="{{ word_data.code | length }}" class="urdu-text" dir="rtl" lang="ur" style="font-size:1.1rem;"
                                                    {% if word_data.explanation %}data-bs-toggle="tooltip" data-bs-title="{{ word_data.explanation }}" data-bs-placement="top"{% endif %}>
                                                    {{ word_data.word }}
                                                </td>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                    <tr>
                                        {% for char in notation_code %}
                                        <td><code class="text-dark" style="font-size: 1.5rem; font-weight: bold;">{{ char }}</code></td>
                                        {% endfor %}
                                    </tr>
                                    {% if has_match and result.feet_list %}
                                    {% set total_bahr_length = notation_code | length %}
                                    {% set has_plus = '+' in notation_code %}
                                    <tr>
                                        {% for foot in result.feet_list %}
                                            {% set foot_length = foot.code | length %}
                                            {% if has_plus and loop.index0 == 1 %}
                                                {% set foot_length = foot_length + 1 %}
                                            {% endif %}
                                            {% set foot_percentage = (foot_length / total_bahr_length * 100) | round(2) %}
                                            {% set bg_color = "#e9ecef" if loop.index0 % 2 == 0 else "white" %}
                                            <td colspan="{{ foot_length }}" class="urdu-text" dir="rtl" lang="ur" style="font-size:1.1rem; background-color: {{ bg_color }}; width: {{ foot_percentage }}%;">{{ foot.foot }}</td>
                                        {% endfor %}
                                    </tr>
                                    {% endif %}
                                </table>
                            </div>
                            {% if has_match and waw_dropped %}
                            <p class="text-center mb-0 mt-1 small text-muted">A  'و'  has been dropped by ataf processing.</p>
                            {% endif %}
                            {% if not multi and has_match %}
                            <div class="text-center mt-3">
                                <h6>Bahr: <span dir="rtl" lang="ur" class="urdu-text">{{ result.meter_name }}</span></h6>
                            </div>
                            {% endif %}
                        {% else %}
                        <div class="alert alert-warning">No scansion data available for this line.</div>
                        {% endif %}
                    </div>
                {% endfor %}
                {% if multi %}
                {% set default_bahr = (line_data.results | selectattr('is_default') | first) or line_data.results[0] %}
                <div class="text-center mt-3">
                    <h6>
                        <label for="bahr-select-{{ line_data.line_index }}">Bahr: </label>
                        <div class="dropdown bahr-dropdown d-inline-block" data-line-index="{{ line_data.line_index }}">
                            <button type="button" id="bahr-select-{{ line_data.line_index }}" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Select bahr">
                                <span class="bahr-dropdown-label urdu-text" dir="rtl" lang="ur">{{ default_bahr.meter_name }}</span>
                            </button>
                            <ul class="dropdown-menu">
                                {% for result in line_data.results %}
                                <li>
                                    <button type="button" class="dropdown-item bahr-dropdown-option urdu-text {{ 'active' if result.is_default else '' }}" dir="rtl" lang="ur" data-value="{{ loop.index0 }}"{% if result.is_default %} aria-current="true"{% endif %}>{{ result.meter_name }}</button>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </h6>
                </div>
                {% endif %}
            {% else %}
                <div class="alert alert-warning">
                    No meter matches found for this line.
                </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    
    <!-- Show overall dominant bahr for the entire poem -->
    {% if poem_dominant_bahrs %}
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="text-center urdu-text mb-0" >
                Poem Bahr: <span dir="rtl" lang="ur">{{ poem_dominant_bahrs | join(", ") }}</span>
            </h5>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Input Card -->
    <div class="card mb-3">
        <div class="card-body py-3">
            <form method="POST" action="/" class="needs-validation" novalidate>
                <label for="text" class="form-label">Enter Urdu Poetry Lines (one per line)</label>

                <textarea
                    class="form-control form-control-lg urdu-input mb-3"
                    id="text"
                    name="text"
                    dir="rtl"
                    lang="ur"
                    placeholder="نقش فریادی ہے کس کی شوخیِ تحریر کا&#10;کاغذی پیرہن میں ہے بند صدف کی طرح"
                    required
                    autofocus
                    rows="5"
                >{{ text_input or "" }}</textarea>

                <div class="invalid-feedback">
                    Please enter Urdu poetry lines.
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100 py-2">
                    Scan Lines
                </button>
            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
    'use strict';
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
})();
</script>
<script>
(function () {
    'use strict';
    
    // Helper function to wrap Urdu text in spans with Nastaliq font
    function wrapUrduText(text) {
        if (!text) return text;
        // Urdu Unicode range: U+0600-U+06FF (Arabic script including Urdu)
        var urduRegex = /[\u0600-\u06FF]+/g;
        return text.replace(urduRegex, function(match) {
            return '<span style="font-family: \'Noto Nastaliq Urdu\', \'Jameel Noori Nastaleeq\', \'Segoe UI\', serif; direction: rtl;">' + match + '</span>';
        });
    }
    
    // Initialize Bootstrap tooltips
    function initializeTooltips() {
        // Dispose existing tooltips first to avoid duplicates
        var existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        existingTooltips.forEach(function (el) {
            var tooltipInstance = bootstrap.Tooltip.getInstance(el);
            if (tooltipInstance) {
                tooltipInstance.dispose();
            }
        });
        
        // Initialize all tooltips
        var tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        var tooltipList = Array.prototype.slice.call(tooltipTriggerList).map(function (tooltipTriggerEl) {
            var tooltip = new bootstrap.Tooltip(tooltipTriggerEl, {
                container: 'body',
                html: true
            });
            
            // Update tooltip content when shown to wrap Urdu text
            tooltipTriggerEl.addEventListener('shown.bs.tooltip', function () {
                var tooltipElement = document.querySelector('.tooltip.show');
                if (tooltipElement) {
                    var tooltipInner = tooltipElement.querySelector('.tooltip-inner');
                    if (tooltipInner) {
                        // Get original title from attribute
                        var originalTitle = tooltipTriggerEl.getAttribute('data-bs-title') || tooltipTriggerEl.getAttribute('title') || '';
                        if (originalTitle) {
                            var processedHTML = wrapUrduText(originalTitle);
                            tooltipInner.innerHTML = processedHTML;
                        }
                    }
                }
            });
            
            return tooltip;
        });
    }
    
    function showHideTables(lineIndex, selectedBahrIndex) {
        document.querySelectorAll('.scansion-table-wrapper[data-line-index="' + lineIndex + '"]').forEach(function (wrapper) {
            if (wrapper.getAttribute('data-bahr-index') === selectedBahrIndex) {
                wrapper.classList.remove('d-none');
            } else {
                wrapper.classList.add('d-none');
            }
        });
        // Reinitialize tooltips after showing/hiding tables
        initializeTooltips();
    }
    
    document.addEventListener('click', function (e) {
        var opt = e.target.closest('.bahr-dropdown .dropdown-item');
        if (!opt) return;
        var dropdown = opt.closest('.bahr-dropdown');
        if (!dropdown) return;
        var lineIndex = dropdown.getAttribute('data-line-index');
        var val = opt.getAttribute('data-value');
        if (val == null) return;
        var label = dropdown.querySelector('.bahr-dropdown-label');
        if (label) label.textContent = opt.textContent.trim();
        dropdown.querySelectorAll('.dropdown-item').forEach(function (o) {
            o.classList.remove('active');
            o.removeAttribute('aria-current');
        });
        opt.classList.add('active');
        opt.setAttribute('aria-current', 'true');
        showHideTables(lineIndex, val);
    });
    
    // Initialize tooltips when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeTooltips);
    } else {
        initializeTooltips();
    }
})();
</script>
{% endblock %}
