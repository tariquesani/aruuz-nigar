{% extends "base.html" %}

{% block title %}Islah — Aruuz Nigar{% endblock %}

{% block extra_head %}
<style>
    [x-cloak] { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div class="container my-5" x-data="islahApp()" x-cloak>
    <h1 class="text-center mb-4">Islah</h1>

    <form @submit.prevent="submit" class="mb-4">
        <div class="mb-3">
            <label for="islah-text" class="form-label">Enter Urdu Poetry Lines (one per line)</label>
            <textarea
                id="islah-text"
                class="form-control form-control-lg urdu-input mb-3"
                dir="rtl"
                lang="ur"
                rows="5"
                placeholder="Start typing your poetry here..."
                x-model="text"
                :disabled="loading"
            ></textarea>
        </div>
        <button
            type="submit"
            class="btn btn-primary"
            :disabled="loading"
        >
            <span x-show="!loading" x-transition>Submit</span>
            <span x-show="loading" x-transition>Submitting…</span>
        </button>
    </form>

    <!-- Scansion grid: one row = one grid; each syllable = one column -->
    <div class="my-3" x-show="result && result.full_code" x-transition>
        <div class="scansion-row">
            <template x-for="(syllable, i) in syllablesWithDeviations" :key="i">
                <span 
                    class="syllable"
                    :class="syllable.deviationType || ''"
                    x-text="syllable.char || ''"
                ></span>
            </template>
        </div>
    </div>

    <div x-show="response !== ''" x-transition>
        <label class="form-label">Response</label>
        <pre class="bg-light border rounded p-3 overflow-auto mb-0" x-text="response"></pre>
    </div>

</div>

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('islahApp', () => ({
        text: '',
        response: '',
        result: null,
        loading: false,

        get syllablesWithDeviations() {
            if (!this.result || !this.result.full_code) {
                return [];
            }

            const code = this.result.full_code.split('');
            const deviations = this.result.deviations || [];
            
            // Build a map of deviations by code_pos
            const deviationMap = new Map();
            deviations.forEach(dev => {
                if (dev.type === 'substitute' || dev.type === 'delete') {
                    deviationMap.set(dev.code_pos, dev);
                }
            });

            // Build array of syllables with deviation info
            const syllables = code.map((char, index) => ({
                char: char,
                index: index,
                deviationType: deviationMap.has(index) ? deviationMap.get(index).type : null,
                expected: deviationMap.has(index) ? deviationMap.get(index).expected : null,
            }));

            // Insert placeholder entries for insertions (sorted by code_pos descending to maintain order)
            const insertions = deviations
                .filter(dev => dev.type === 'insert')
                .sort((a, b) => b.code_pos - a.code_pos); // Sort descending to insert from end

            insertions.forEach(ins => {
                // Insert at code_pos (before the syllable at that position)
                syllables.splice(ins.code_pos, 0, {
                    char: '',
                    index: ins.code_pos,
                    deviationType: 'insert',
                    expected: ins.expected,
                });
            });

            return syllables;
        },

        async submit() {
            this.loading = true;
            this.response = '';
            this.result = null;
            try {
                const res = await fetch('/api/islah', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: this.text }),
                });
                this.response = await res.text();
                if (!res.ok) {
                    this.response = this.response || `HTTP ${res.status}`;
                } else {
                    try {
                        this.result = JSON.parse(this.response);
                    } catch (_) {
                        this.result = null;
                    }
                }
            } catch (err) {
                this.response = err.message || 'Request failed';
            } finally {
                this.loading = false;
            }
        },
    }));
});
</script>
{% endblock %}
